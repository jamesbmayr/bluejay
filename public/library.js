/* phrase library */
	window.PHRASE_LIBRARY = {
		// settings
			"change voice to": 					"change voice",
			"change the voice to": 				"change voice",
			"set voice to": 					"change voice",
			"set the voice to": 				"change voice",
			"set new voice": 					"change voice",
			"switch voice to": 					"change voice",
			"switch the voice to": 				"change voice",

			"change volume to": 				"change volume",
			"change the volume to": 			"change volume",
			"set volume to": 					"change volume",
			"set the volume to": 				"change volume",
			"set new volume": 					"change volume",

			"edit configuration": 				"edit configuration",
			"edit configuration for": 			"edit configuration",
			"set configuration": 				"edit configuration",
			"set a configuration": 				"edit configuration",
			"set this configuration": 			"edit configuration",
			"set configuration for": 			"edit configuration",
			"set a configuration for": 			"edit configuration",
			"set the configuration for": 		"edit configuration",
			"set my configuration for": 		"edit configuration",
			"set new configuration": 			"edit configuration",
			"set new configuration for": 		"edit configuration",
			"set a new configuration": 			"edit configuration",
			"set a new configuration for": 		"edit configuration",
			"change a configuration": 			"edit configuration",
			"change my configuration": 			"edit configuration",
			"change my configuration for": 		"edit configuration",
			"add to my profile": 				"edit configuration",
			"add this to my profile": 			"edit configuration",
			"edit my profile": 					"edit configuration",
			"save my": 							"edit configuration",
			"set my saved": 					"edit configuration",
			"change my saved": 					"edit configuration",
			"update my saved": 					"edit configuration",
			"configure my": 					"edit configuration",
			"configure": 						"edit configuration",

			"authorize": 						"authorize",
			"create authorization": 			"authorize",
			"get authorization link": 			"authorize",
			"activate": 						"authorize",
			"create activation": 				"authorize",
			"get activation link": 				"authorize",

		// meta
			"repeat after me": 					"repeat this",
			"repeat this": 						"repeat this",
			"say what i say": 					"repeat this",
			"say exactly what i say": 			"repeat this",
			"say this back": 					"repeat this",
			"jot this down": 					"repeat this",
			"copy this down": 					"repeat this",
			"write this down": 					"repeat this",

			"repeat that": 						"repeat that",
			"repeat what you said": 			"repeat that",
			"say what you said": 				"repeat that",
			"say what you said again": 			"repeat that",
			"say that again": 					"repeat that",
			"run that by me again": 			"repeat that",
			"can you repeat that": 				"repeat that",
			"i didnt catch that": 				"repeat that",

			"thank you": 						"gratitude",
			"thanks": 							"gratitude",
			"i appreciate": 					"gratitude",
			"well thank you": 					"gratitude",
			"well thanks": 						"gratitude",
			"good job": 						"gratitude",
			"excellent work": 					"gratitude",
			"job well done": 					"gratitude",
			"well done": 						"gratitude",

			"im sorry": 						"forgiveness",
			"sorry": 							"forgiveness",
			"i am sorry": 						"forgiveness",
			"i apologize": 						"forgiveness",
			"my apologies": 					"forgiveness",
			"apologies": 						"forgiveness",
			"can you forgive": 					"forgiveness",
			"do you forgive": 					"forgiveness",
			"would you forgive": 				"forgiveness",

			"who is a good": 					"affirmation",
			"whos a good": 						"affirmation",
			"whose a good": 					"affirmation",
			"who is my good": 					"affirmation",
			"whos my good": 					"affirmation",
			"whose my good": 					"affirmation",
			"youre an excellent": 				"affirmation",
			"you are an excellent": 			"affirmation",
			"youre a good": 					"affirmation",
			"you are a good": 					"affirmation",
			"youre great": 						"affirmation",
			"you are great": 					"affirmation",
			"youre wonderful": 					"affirmation",
			"you are wonderful": 				"affirmation",
			"youre awesome": 					"affirmation",
			"you are awesome": 					"affirmation",
			"youre wonderful": 					"affirmation",
			"you are wonderful": 				"affirmation",
			"youre amazing": 					"affirmation",
			"you are amazing": 					"affirmation",

		// time
			"what time is it": 					"what time is it",
			"what is the time": 				"what time is it",
			"whats the time": 					"what time is it",
			"tell me the time": 				"what time is it",

			"what day is it": 					"what day is it",
			"what day is today": 				"what day is it",
			"whats the day": 					"what day is it",
			"whats today": 						"what day is it",
			"tell me the day": 					"what day is it",

			"what month is it": 				"what month is it",
			"what is the month": 				"what month is it",
			"whats the month": 					"what month is it",
			"tell me the month": 				"what month is it",

			"what date is it": 					"what is the date",
			"whats todays date": 				"what is the date",
			"what is the date": 				"what is the date",
			"what is todays date": 				"what is the date",
			"whats the date": 					"what is the date",
			"tell me the date": 				"what is the date",

			"set a timer": 						"set alarm",
			"set timer": 						"set alarm",
			"set an alarm": 					"set alarm",
			"set alarm": 						"set alarm",
			"wake me up": 						"set alarm",
			"alert me": 						"set alarm",

		// rng
			"roll": 							"roll dice",
			"roll me": 							"roll dice",
			"roll me some": 					"roll dice",
			"roll some": 						"roll dice",

			"flip a coin": 						"flip a coin",
			"heads or tails": 					"flip a coin",

		// math
			"calculate": 						"calculate",
			"lets do some math": 				"calculate",
			"do some math for me": 				"calculate",
			"add": 								"calculate",
			"subtract": 						"calculate",
			"multiply": 						"calculate",
			"divide": 							"calculate",
			
			"double": 							"double",
			"triple": 							"triple",

			"average": 							"average",
			"find the average of": 				"average",
			"what is the average of": 			"average",
			"whats the average of": 			"average",

			"start counting": 					"count",
			"count": 							"count",
			"can you count": 					"count",
			"lets count": 						"count",
			"give me a count": 					"count",

		// word api fetches
			"what rhymes with": 				"find rhymes",
			"find a rhyme for": 				"find rhymes",
			"find rhymes for": 					"find rhymes",
			"get a rhyme for": 					"find rhymes",
			"get rhymes for": 					"find rhymes",
			"rhymes with": 						"find rhymes",
			"something that rhymes with": 		"find rhymes",

			"what is a synonym for": 			"find synonyms",
			"find a synonym for": 				"find synonyms",
			"find synonyms for": 				"find synonyms",
			"get a synonym for": 				"find synonyms",
			"get synonyms for": 				"find synonyms",
			"synonym of": 						"find synonyms",
			"what has the same meaning as": 	"find synonyms",

			"define": 							"define",
			"define the word": 					"define",
			"look up the word": 				"define",
			"provide a definition for": 		"define",
			"what is the meaning of": 			"define",
			"whats the meaning of": 			"define",

		// content api fetches
			"tell me a joke": 					"tell a joke",
			"know any jokes": 					"tell a joke",
			"do you know any jokes": 			"tell a joke",
			"say something funny": 				"tell a joke",
			"be funny": 						"tell a joke",
			"i could use a joke": 				"tell a joke",
			"tell a joke": 						"tell a joke",
			"tell us a joke": 					"tell a joke",
			"make me laugh": 					"tell a joke",
			"fetch a joke": 					"tell a joke",
			"fetch me a joke": 					"tell a joke",
			"tell me something funny": 			"tell a joke",

			"get a quote": 						"get a quote",
			"get me a quote": 					"get a quote",
			"give me a quote": 					"get a quote",
			"get a random quote": 				"get a quote",
			"get me a random quote": 			"get a quote",
			"give me a random quote": 			"get a quote",
			"random quote": 					"get a quote",
			"famous quote": 					"get a quote",
			"inspire me": 						"get a quote",
			"tell me a random quote": 			"get a quote",
			"tell me a quote": 					"get a quote",
			"fetch a quote": 					"get a quote",
			"fetch me a quote": 				"get a quote",

			"get the headlines": 				"get the headlines",
			"get todays headlines": 			"get the headlines",
			"whats happening in the world": 	"get the headlines",
			"what is happening in the world": 	"get the headlines",
			"get the top stories": 				"get the headlines",
			"get me the news": 					"get the headlines",
			"give me the news": 				"get the headlines",
			"fetch the news": 					"get the headlines",
			"what is the news": 				"get the headlines",
			"whats the news": 					"get the headlines",
			"whats the latest news": 			"get the headlines",
			"what is the latest news": 			"get the headlines",
			"whats happening in the news": 		"get the headlines",
			"what is happening in the news": 	"get the headlines",
			"read the headlines": 				"get the headlines",
			"read me the headlines": 			"get the headlines",

			"get the weather": 					"get the weather",
			"get the weather": 					"get the weather",
			"whats the weather": 				"get the weather",
			"what is the weather": 				"get the weather",
			"what will the be": 				"get the weather",
			"hows the weather": 				"get the weather",
			"how is the weather": 				"get the weather",
			"is it going to rain": 				"get the weather",
			"will it rain": 					"get the weather",
			"is it going to snow": 				"get the weather",
			"will it snow": 					"get the weather",

		// Google Apps Script
			"add to wish list": 				"wish list",
			"add to my wish list": 				"wish list",
			"add this to my wish list": 		"wish list",
			"include on my wish list": 			"wish list",
			"edit my wish list to include": 	"wish list",

			"what is my account balance for": 	"get balance",
			"whats my account balance for": 	"get balance",
			"check my account balance for": 	"get balance",
			"how much money do i have in": 		"get balance",
			"how much do i have in": 			"get balance",
			"how much money do i have in my": 	"get balance",
			"how much do i have in my": 		"get balance",
			"what is the balance in my": 		"get balance",
			"whats the balance in my": 			"get balance",
			"what is the balance on my": 		"get balance",
			"whats the balance on my": 			"get balance",
			"how much money is left in my": 	"get balance",
			"how much money is in my": 			"get balance",
			"how much is in my": 				"get balance",

			"i just bought": 					"log purchase",
			"i bought": 						"log purchase",
			"add a purchase": 					"log purchase",
			"add a purchase of": 				"log purchase",
			"add my purchase": 					"log purchase",
			"add my purchase of": 				"log purchase",
			"record a purchase": 				"log purchase",
			"record my purchase": 				"log purchase",
			"record a purchase of": 			"log purchase",
			"record my purchase of": 			"log purchase",
			"log a purchase": 					"log purchase",
			"log my purchase": 					"log purchase",
			"log a purchase of": 				"log purchase",
			"log my purchase of": 				"log purchase",

			"fetch events": 					"fetch events",
			"fetch my events": 					"fetch events",
			"fetch upcoming events": 			"fetch events",
			"fetch my upcoming events": 		"fetch events",
			"fetch my calendar": 				"fetch events",
			"what is on my calendar": 			"fetch events",
			"whats on my calendar": 			"fetch events",
			"what is on the calendar": 			"fetch events",
			"whats on the calendar": 			"fetch events",
			"what is happening": 				"fetch events",
			"whats happening": 					"fetch events",

		// Google APIs
			"look this up on google": 			"google search",
			"do a google search": 				"google search",
			"do a google search for": 			"google search",
			"google": 							"google search",
			"do a search for": 					"google search",
			"do a search": 						"google search",
			"search": 							"google search",
			"i wonder if": 						"google search",
			"i wonder": 						"google search",
			"i am curious": 					"google search",
			"im curious": 						"google search",

			"how do i get": 					"google directions",
			"how do i go": 						"google directions",
			"tell me how to get": 				"google directions",
			"tell me how to go": 				"google directions",
			"get me directions": 				"google directions",
			"get directions": 					"google directions",
			"look up directions": 				"google directions",
			"look up how to get": 				"google directions",
			"look up how to go": 				"google directions",
			"get a route": 						"google directions",
			"route me": 						"google directions",

			"find a place": 					"google places",
			"find a place called": 				"google places",
			"find a place named": 				"google places",
			"find a place by the name": 		"google places",
			"find me a place": 					"google places",
			"find me a place called": 			"google places",
			"find me a place named": 			"google places",
			"find me a place by the name": 		"google places",
			"look up a place": 					"google places",
			"look up a place called": 			"google places",
			"look up a place named": 			"google places",
			"look up a place by the name": 		"google places",
			"look for a place": 				"google places",
			"look for a place called": 			"google places",
			"look for a place named": 			"google places",
			"look for a place by the name": 	"google places",

			"search youtube for": 				"youtube",
			"find on youtube": 					"youtube",
			"on youtube find": 					"youtube",
			"on youtube look for": 				"youtube",
			"on youtube play": 					"youtube",
			"on youtube try": 					"youtube",
			"play on youtube": 					"youtube",
			"play this on youtube": 			"youtube",
			"lets watch": 						"youtube",
			"lets listen to": 					"youtube",
			"on youtube put on": 				"youtube",
			"on youtube open up": 				"youtube",
			"on youtube open": 					"youtube",

		// games
			"lets play more or less": 			"more or less",
			"lets play the more or less game": 	"more or less",
			"think of a number": 				"more or less",
			"pick a number": 					"more or less",
			"i want to guess a number": 		"more or less",
			"play more or less": 				"more or less",
			"lets play more or less": 			"more or less",

			"quiz me": 							"true or false",
			"tell me a fact": 					"true or false",
			"tell me a fun fact": 				"true or false",
			"give me a fact": 					"true or false",
			"give me a fun fact": 				"true or false",
			"lets do trivia": 					"true or false",
			"lets do some trivia": 				"true or false",
			"lets play trivia": 				"true or false",
			"lets play some trivia": 			"true or false",
			"play true or false": 				"true or false",
			"lets play true or false": 			"true or false",

		// SONOS

		// Wink
			"on wink get devices": 				"get wink devices",
			"on wink get my devices": 			"get wink devices",
			"on wink get all devices": 			"get wink devices",
			"on wink get the devices": 			"get wink devices",
			"on wink get all the devices": 		"get wink devices",
			"on wink get all of the devices": 	"get wink devices",

			"on wink set": 						"set wink devices",
			"on wink update": 					"set wink devices",
			"on wink turn": 					"set wink devices",
			"on wink change": 					"set wink devices",
			"on wink alter": 					"set wink devices",
			"on wink make": 					"set wink devices",

			"on wink turn off": 				"turn off wink device",
			"on wink switch off": 				"turn off wink device",
			"on wink turn off": 				"turn off wink device",
			"on wink deactivate": 				"turn off wink device",

			"on wink turn on": 					"turn on wink device",
			"on wink switch on": 				"turn on wink device",
			"on wink flip on": 					"turn on wink device",
			"on wink activate": 				"turn on wink device",

		// Reddit
			"ask reddit": 						"ask reddit",
			"ask a question": 					"ask reddit",
			"ask me a question": 				"ask reddit",
			"ask us a question": 				"ask reddit",
			"ask me something": 				"ask reddit",
			"ask us something": 				"ask reddit",
			"ask something": 					"ask reddit",
			"change the subject": 				"ask reddit",
			"change the topic": 				"ask reddit",
			"change topic": 					"ask reddit",
			"change subject": 					"ask reddit",
	}

/* action library */
	window.ACTION_LIBRARY = {
		// settings
			"change voice": function(remainder, callback) {
				try {
					var name = remainder.toLowerCase().replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim()
					var success = window.FUNCTION_LIBRARY.changeVoice({name: name})
					if (!success) {
						callback({message: "I don't recognize that voice.", html: "voice not found: " + remainder})
					}
					else {
						callback({message: "Voice set to " + name, html: "voice: " + name})
					}
				} catch (error) {}
			},
			"change volume": function(remainder, callback) {
				try {
					var volume = remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim()
						volume = window.FUNCTION_LIBRARY.getDigits(volume)

					var success = window.FUNCTION_LIBRARY.changeVoiceVolume({volume: volume})
					if (!success) {
						callback({message: "That's not a valid number.", html: "invalid volume: " + remainder})
					}
					else {
						callback({message: "Volume set to " + volume, html: "volume: " + Math.round(Math.max(0, Math.min(100, Number(volume))))})
					}
				} catch (error) {}
			},
			"edit configuration": function(remainder, callback) {
				try {
					// get key and value
						var pair = remainder.split(/ equal to | equals | to | is | as /gi)
						if (pair[0] === undefined || pair[0] === null || pair[1] === undefined || pair[1] === null) {
							callback({message: "The key or value is missing.", html: "invalid key or value"})
							return
						}
						else {
							var key = String(pair[0]).toLowerCase()
							var value = String(pair[1])
						}

					// try converting to number
						if (!isNaN(Number(value))) {
							value = Number(value)
						}

					// save and respond
						var success = window.FUNCTION_LIBRARY.changeConfiguration({key: key, value: value})
						if (!success) {
							callback({message: "I couldn't set that configuration.", html: "invalid or missing key and value"})
						}
						else {
							callback({message: key + " is now " + value, html: key + " = " + value})
						}
				} catch (error) {}
			},
			"authorize": function(remainder, callback) {
				try {
					// get credentials
						var credentials = remainder.split(/\s/gi)
						var name = credentials[0].toLowerCase() || ""

					// no platform?
						var platforms = {
							"sonos": {
								host: "api.sonos.com",
								authPath: "/login/v3/oauth?response_type=code&scope=playback-control-all",
								reauthPath: "/login/v3/oauth/access",
								stateSecret: function(key, secret) { return btoa(key + ":" + secret) }
							},
							"wink": {
								host: "api.wink.com",
								authPath: "/oauth2/authorize?response_type=code",
								reauthPath: "/oauth2/token",
								stateSecret: function(key, secret) { return secret }
							},
							"reddit": {
								host: "www.reddit.com",
								authPath: "/api/v1/authorize/?response_type=code&duration=permanent&scope=read",
								reauthPath: "/api/v1/access_token",
								stateSecret: function(key, secret) { return btoa(key + ":" + secret) }
							}
						}

						if (!name || !Object.keys(platforms).includes(name)) {
							callback({message: "I couldn't identify that platform.", html: "unable to authorize: <b>" + remainder + "</b>"})
						}

					// credentials?
						else {
							// host
								var host = platforms[name].host

							// fresh
								if (!window.CONFIGURATION_LIBRARY[host]) {
									var key = credentials[1] || window.CONFIGURATION_LIBRARY[name + " key"] || ""
									var secret = credentials[2] || window.CONFIGURATION_LIBRARY[name + " secret"] || ""
									var redirect = credentials[2] || window.CONFIGURATION_LIBRARY[name + " redirect"] || ""

									if (!key || !secret || !redirect) {
										callback({message: "To connect to " + name + ", I need a key, a secret, and a redirect.", html: "unable to authorize: <b>" + remainder + "</b><br><br><b>required configurations:</b><ul><li>" + name + " key</li><li>" + name + " secret</li><li>" + name + " redirect</li></ul>"})
									}
									else {
										var state = encodeURIComponent(window.location + ";;;" + platforms[name].stateSecret(key, secret))
										var url = "https://" + host + platforms[name].authPath + "&client_id=" + key + "&state=" + state + "&redirect_uri=" + encodeURIComponent(redirect)
										var popup = window.open(url, null, "height=500,width=500,status=yes,toolbar=no,menubar=no,location=no")

										callback({message: "Complete the authorization flow for " + host, html: "activating <b>" + host + "</b> in external popup"})

										window.FUNCTION_LIBRARY.fetchPeriodically("getAuthorization", host, function(data) {
											var value = window.CONFIGURATION_LIBRARY[host] || {}
												value.access_token = data.access_token
												value.refresh_token = data.refresh_token
												value.expiration = new Date().getTime() + (data.expires_in * 1000)
											window.FUNCTION_LIBRARY.changeConfiguration({key: host, value: value})
											callback({message: host + " is now authorized", html: "<b>" + host + "</b> is authorized until " + new Date(CONFIGURATION_LIBRARY[host].expiration).toLocaleString()})
										})
									}

									// THE BLUEJAY-OAUTH FLOW
										// 1: parse the user response or look in the CONFIGURATION_LIBRARY for the platform's key, secret, and redirect
										// 2: create a popup to the platform's auth screen; the "state" query param includes bluejay url and platform API key and/or secret
										// 3: user goes through and completes the auth flow
										// 4: external platform redirects the popup based the redirect param (currently a Google Apps Script); auth code is a param of this page
										// 5: Google Apps Script logs this and uses the "state" param and the new auth code to generate a bluejay link to /authorization
										// 6: the page auto-redirects to the /authorization url, with an embeddedPost parameter
										// 7: bluejay server interprets this param and sends an API request to external platform with the auth code
										// 8: platform responds with the actual access token (and refresh token)
										// 9: bluejay server saves the results of this to the db, specifically under the user's session id
										// 10: the main window had been requesting this data the whole time, and now it gets a success response
										// 11: bluejay saves these values to CONFIGURATION_LIBRARY and localStorage
										// 12: subsequent Sonos API calls can include the access_token
								}

							// expired
								else if (window.CONFIGURATION_LIBRARY[host] && (!window.CONFIGURATION_LIBRARY[host].expiration || window.CONFIGURATION_LIBRARY[host].expiration < new Date().getTime())) {
									var key = credentials[1] || window.CONFIGURATION_LIBRARY[name + " key"] || ""
									var secret = credentials[2] || window.CONFIGURATION_LIBRARY[name + " secret"] || ""
									var refresh_token = window.CONFIGURATION_LIBRARY[host].refresh_token || ""

									if (!key || !secret || !refresh_token) {
										callback({message: "To reconnect to " + name + ", I need a key, a secret, and a refresh_token.", html: "unable to reauthorize: <b>" + remainder + "</b><br><br><b>required configurations:</b><ul><li>" + name + " key</li><li>" + name + " secret</li><li>" + name + " refresh_token</li></ul>"})
									}
									else {
										var url = "https://" + host + platforms[name].reauthPath
										var options = {
											method: "post",
											url: url,
											"Content-Type": "application/json",
											body: {
												"grant_type": "refresh_token",
												"client_id": key,
												"client_secret": secret,
												"refresh_token": refresh_token
											}
										}

										window.FUNCTION_LIBRARY.proxyRequest(options, function(data) {
											try {
												var value = window.CONFIGURATION_LIBRARY[host]
													value.access_token = data.access_token
													value.refresh_token = refresh_token
													value.expiration = new Date().getTime() + (data.expires_in * 1000)
												window.FUNCTION_LIBRARY.changeConfiguration({key: host, value: value})
												callback({message: host + " is now reauthorized", html: "<b>" + host + "</b> is authorized until " + new Date(CONFIGURATION_LIBRARY[host].expiration).toLocaleString()})
											}
											catch (error) {
												callback({message: "I couldn't reauthorize " + host, html: "unable to reauthorize <b>" + host + "</b>"})
											}
										})
									}
								}

							// already authorized
								else {
									callback({message: host + " is already authorized", html: "<b>" + host + "</b> is authorized until " + new Date(CONFIGURATION_LIBRARY[host].expiration).toLocaleString()})
								}
						}
				} catch (error) {}
			},

		// meta
			"repeat this": function(remainder, callback) {
				try {
					callback({message: remainder, html: remainder})
				} catch (error) {}
			},
			"repeat that": function(remainder, callback) {
				try {
					callback({message: window.CONTEXT_LIBRARY.lastResponseMessage || "No previous response.", html: window.CONTEXT_LIBRARY.lastResponseHTML || "No previous response."})
				} catch (error) {}
			},
			"gratitude": function(remainder, callback) {
				try {
					var messages = ["You're welcome.", "Glad I could help.", "Any time.", "Don't mention it.", "No problem."]
					var message = messages[Math.floor(Math.random() * messages.length)]
					callback({message: message, html: message })
				} catch (error) {}
			},
			"forgiveness": function(remainder, callback) {
				try {
					var messages = ["Don't worry about it.", "I forgive you.", "It's all right.", "No worries.", "Everything will be okay."]
					var message = messages[Math.floor(Math.random() * messages.length)]
					callback({message: message, html: message })
				} catch (error) {}
			},
			"affirmation": function(remainder, callback) {
				try {
					var messages = ["I am a good bird.", "Thank you. I try my hardest.", "That's kind of you to say.", "I'm glad you think so.", "I appreciate that."]
					var message = messages[Math.floor(Math.random() * messages.length)]
					callback({message: message, html: message})
				} catch (error) {}
			},

		// time
			"what time is it": function(remainder, callback) {
				try {
					var response = new Date().toLocaleTimeString()
					callback({message: response, html: "The time is " + response + "."})
				} catch (error) {}
			},
			"what day is it": function(remainder, callback) {
				try {
					var response = (["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date().getDay()])
					callback({message: response, html: "Today is " + response + "."})
				} catch (error) {}
			},
			"what month is it": function(remainder, callback) {
				try {
					var response = (["January","February","March","April","May","June","July","August","September","October","November","December"][new Date().getMonth()])
					callback({message: response, html: "The month is " + response + "."})
				} catch (error) {}
			},
			"what is the date": function(remainder, callback) {
				try {
					var response = (["January","February","March","April","May","June","July","August","September","October","November","December"][new Date().getMonth()] + " " + new Date().getDate())
					callback({message: response, html: "The date is " + response + "."})
				} catch (error) {}
			},
			"set alarm": function(remainder, callback) {
				try {
					// split into array
						var words = remainder.split(/\s/gi) || []

					// timer
						if ((/second|minute|hour|day|in/gi).test(remainder)) {
							var units = {
								"second": 1000,
								"minute": 1000 * 60,
								"hour": 1000 * 60 * 60,
								"day": 1000 * 60 * 60 * 24
							}
							var keys = Object.keys(units)

							var amounts = []
							for (var i in words) {
								words[i] = window.FUNCTION_LIBRARY.getDigits(words[i])

								if (!isNaN(words[i])) {
									if (words[i + 1] && keys[words[i + 1].replace(/s$/gi,"").toLowerCase()]) {
										amounts.push({
											number: Number(words[i]),
											unit: words[i + 1].replace(/s$/gi,"")
										})
									}
									else {
										amounts.push({
											number: Number(words[i]),
											unit: "minute"
										})
									}
								}
							}

							var duration = 0
							for (var i in amounts) {
								duration += (amounts[i].number * units[amounts[i].unit])
							}

							if (!duration) {
								callback({message: "I was unable to set that timer.", html: "unable to set timer: " + response})
							}
							else {
								var endTime = new Date().getTime() + duration
								CONTEXT_LIBRARY.alarms.push(endTime)
								callback({message: "Alarm set for " + new Date(endTime).toLocaleTimeString(), html: "&#128339; Alarm set for <b>" + new Date(endTime).toLocaleString() + "</b>"})
							}
						}

					// alarm
						else {
							var timePhrase = remainder.replace(/in|at|for|after|before|around/gi,"").toLowerCase().trim()
								timePhrase = timePhrase.replace("p.m.", "PM").replace("a.m.", "AM")
							var endTime = new Date(timePhrase).getTime() || new Date(new Date().toDateString() + " " + timePhrase).getTime()
							
							if (isNaN(endTime)) {
								callback({message: "I was unable to set that alarm.", html: "unable to set alarm: " + response})
							}
							else {
								if (endTime < new Date().getTime()) {
									var endTime = new Date(new Date(new Date().getTime() + (1000 * 60 * 60 * 24)).toDateString() + " " + timePhrase).getTime()
								}

								CONTEXT_LIBRARY.alarms.push(endTime)
								callback({message: "Alarm set for " + new Date(endTime).toLocaleTimeString(), html: "&#128339; Alarm set for <b>" + new Date(endTime).toLocaleString() + "</b>"})
							}
						}
				} catch (error) {}
			},

		// rng
			"roll dice": function(remainder, callback) {
				try {
					// defaults
						var count = 1
						var sides = 6
						remainder = " " + remainder

					// X dice with Y sides format
						if (remainder.includes("side") || remainder.includes("face")) {
							var count = Number(window.FUNCTION_LIBRARY.getDigits(remainder.split(/ dice with | die with | dice having /gi)[0])) || 1
							var sides = Number(window.FUNCTION_LIBRARY.getDigits((remainder.split(/ dice with | die with | dice having /gi)[1] || "").replace(/sides/gi,"").replace(/faces/gi,"").replace(/side/gi,"").replace(/face/gi,"")))
						}

					// XdY format
						else {
							var count = Number(window.FUNCTION_LIBRARY.getDigits(remainder.split(/d/gi)[0])) || 1
							var sides = Number(remainder.split(/d/gi)[1])
						}

					// roll dice
						var sum = 0
						for (var i = 0; i < count; i++) {
							sum += Math.floor(Math.random() * sides) + 1
						}

					// return sum
						callback({message: sum || "Unable to roll dice.", html: count + "d" + sides + ": " + (sum || "invalid dice")})
				} catch (error) {}
			},
			"flip a coin": function(remainder, callback) {
				try {
					var response = ["heads","tails"][Math.floor(Math.random() * 2)]
					callback({message: response, html: "coin: " + response})
				} catch (error) {}
			},
		
		// math
			"calculate": function(remainder, callback) {
				try {
					// loop through and identify terms
						var terms = remainder.split(/\s/gi)
						for (var i = 0; i < terms.length; i++) {
							if (isNaN(terms[i])) {
								terms[i] = terms[i].toLowerCase()
								if      (terms[i] == "by")      { terms[i] = "" }
								else if (terms[i] == "of")      { terms[i] = "" }
								else if (terms[i] == "plus")    { terms[i] = "+" }
								else if (terms[i] == "minus")   { terms[i] = "-" }
								else if (terms[i] == "times")   { terms[i] = "*" }
								else if (terms[i] == "divided") { terms[i] = "/" }
								else if (terms[i] == "squared") { terms[i] = "** 2" }
								else if (terms[i] == "cubed")   { terms[i] = "** 3" }
								else if (terms[i] == "halved")  { terms[i] = "/ 2" }
								else if (terms[i] == "power")   { terms[i] = "**" }
								else if (terms[i] == "root")    { terms[i] = "** (1/"; terms.splice(i + 2, 0, ")")}
								else if (terms[i] == "percent") { terms[i] = "/ 100 *"}
								else if (terms[i] == "(" || terms[i] == ")") {}
								else {
									terms[i] = window.FUNCTION_LIBRARY.getDigits(terms[i])
								}
							}
							else {
								terms[i] = Number(terms[i])
							}
						}

					// evaluate and return result
						var result = eval(terms.join(" "))
						if (isNaN(result)) {
							callback({message: "Unable to calculate.", html: "invalid calculation: " + remainder})
						}
						else {
							callback({message: Number(result), html: terms.join(" ") + " = " + result})
						}
				}
				catch (error) { callback({message: "Unable to calculate.", html: "invalid calculation"}) }
			},
			"double": function(remainder, callback) {
				try {
					var term = remainder.replace(/[?!,:;'"_\/\(\)\$\%]/gi,"")
						term = window.FUNCTION_LIBRARY.getDigits(term)
					var result = 2 * Number(term)
					if (isNaN(result)) {
						callback({message: "Unable to calculate.", html: "invalid calculation"})
					}
					else {
						callback({message: Number(result), html: "2 * " + term + " = " + result})
					}
				}
				catch (error) { callback({message: "Unable to calculate.", html: "invalid calculation"}) }
			},
			"triple": function(remainder, callback) {
				try {
					var term = remainder.replace(/[?!,:;'"_\/\(\)\$\%]/gi,"")
						term = window.FUNCTION_LIBRARY.getDigits(term)
					var result = 3 * Number(term)
					if (isNaN(result)) {
						callback({message: "Unable to calculate.", html: "invalid calculation"})
					}
					else {
						callback({message: Number(result), html: "3 * " + term + " = " + result})
					}
				}
				catch (error) { callback({message: "Unable to calculate.", html: "invalid calculation"}) }
			},
			"average": function(remainder, callback) {
				try {
					// loop through and aggregate terms
						var terms = remainder.replace(/[?!,:;'"_\/\(\)\$\%]/gi,"").split(/\s/gi)
						var numbers = []
						for (var i = 0; i < terms.length; i++) {
							terms[i] = window.FUNCTION_LIBRARY.getDigits(terms[i])

							if (!isNaN(terms[i])) {
								numbers.push(Number(terms[i]))
							}
						}

						var result = numbers.reduce(function(total, term) {
							return (total + term)
						}) / (numbers.length || 1)

					// return result
						if (isNaN(result)) {
							callback({message: "Unable to calculate.", html: "invalid calculation"})
						}
						else {
							callback({message: Number(result), html: numbers.join(" + ") + " / " + numbers.length + " = " + result})
						}
				}
				catch (error) { callback({message: "Unable to calculate.", html: "invalid calculation"}) }
			},
			"count": function(remainder, callback) {
				try {
					// numbers
						var startNumber = (" " + remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"")).split(/ up from | down from | from | starting at | start at | between | for /gi)
							startNumber = (startNumber[1] || startNumber[0]).split(/ and go to | and go until | up to | down to | to | until | ending at | end at | and | through /gi)[0].toLowerCase().trim()
							startNumber = window.FUNCTION_LIBRARY.getDigits(startNumber)
						if (!startNumber || isNaN(startNumber)) { startNumber = 1 }

						var endNumber = (" " + remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"")).split(/ and go to | and go until | up to | down to | to | until | ending at | end at | and | through /gi)
							endNumber = (endNumber[1] || endNumber[0]).split(/ up from | down from | starting at | start at | between | for /gi)[0].toLowerCase().trim()
							endNumber = window.FUNCTION_LIBRARY.getDigits(endNumber)
						if (!endNumber || isNaN(endNumber)) { endNumber = 100 }

					// up or down
						var list = []
						if (startNumber <= endNumber) {
							for (var i = startNumber; i <= endNumber; i++) {
								list.push(i)
							}
						}
						else {
							for (var i = startNumber; i >= endNumber; i--) {
								list.push(i)
							}
						}

					// message
						callback({message: list.join("..."), html: "Counting from <b>" + String(startNumber) + "</b> to <b>" + String(endNumber) + "</b>."})

				} catch (error) {}
			},

		// word api fetches
			"find rhymes": function(remainder, callback) {
				try {
					// options
						var options = {
							url: "https://api.datamuse.com/words?rel_rhy=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim()
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response list
									var list = response || []
									var listItems = []
									for (var i in list) {
										list[i] = list[i].word
										listItems[i] = "<li>" + list[i] + "</li>"
									}

								// message, link, list
									var message = "I found " + list.length + " rhyme" + (list.length == 1 ? "" : "s") + " for " + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim() + "."
									var link = "<a target='_blank' href='https://rhymezone.com/r/rhyme.cgi?typeofrhyme=perfect&Word=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim() + "'>" + message + "</a>"
									callback({message: message + " " + list.join(","), html: link + "<ul>" + listItems.join("") + "</ul>"})
							}
							catch (error) {
								callback({message: "I can't rhyme that.", html: "invalid word: " + remainder})
							}
						})
				} catch (error) {}
			},
			"find synonyms": function(remainder, callback) {
				try {
					// options
						var options = {
							url: "https://api.datamuse.com/words?rel_syn=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim()
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response list
									var list = response || []
									var listItems = []
									for (var i in list) {
										list[i] = list[i].word
										listItems[i] = "<li>" + list[i] + "</li>"
									}

								// message, link, list
									var message = "I found " + list.length + " synonym" + (list.length == 1 ? "" : "s") + " for " + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim() + "."
									var link = "<a target='_blank' href='https://rhymezone.com/r/rhyme.cgi?typeofrhyme=syn&Word=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim() + "'>" + message + "</a>"
									callback({message: message + " " + list.join(","), html: link + "<ul>" + listItems.join("") + "</ul>"})
							}
							catch (error) {
								callback({message: "I don't know any synonyms for that.", html: "invalid word: " + remainder})
							}
						})
				} catch (error) {}
			},
			"define": function(remainder, callback) {
				try {
					// options
						var options = {
							url: "https://api.datamuse.com/words?md=d&sp=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim()
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response list
									var word = response[0]
									var list = []
									var listItems = []
									for (var i in word.defs) {
										word.defs[i] = "[" + word.defs[i].replace(/\t/,"] ")
										word.defs[i] = word.defs[i].replace("[n]", "[noun]").replace("[v]", "[verb]").replace("[adj]", "[adjective]").replace("[adv]", "[adverb]").replace("[u]", "[other]")
										list[i] = word.defs[i]
										listItems[i] = "<li>" + word.defs[i] + "</li>"
									}

								// message, link, list
									var message = "I found " + list.length + " definition" + (list.length == 1 ? "" : "s") + " for " + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim() + "."
									var link = "<a target='_blank' href='http://wordnetweb.princeton.edu/perl/webwn?s=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim() + "'>" + message + "</a>"
									callback({message: message + " " + list.join(","), html: link + "<ul>" + listItems.join("") + "</ul>"})
							}
							catch (error) {
								callback({message: "I can't define that.", html: "invalid word: " + remainder})
							}
						})
				} catch (error) {}
			},

		// content api fetches
			"tell a joke": function(remainder, callback) {
				try {
					// options
						var options = {
							url: "https://icanhazdadjoke.com/slack"
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response link
									var jokeLink = "https://icanhazdadjoke.com"
									var jokeText = response.attachments[0].text
									callback({message: jokeText, html: "<a target='_blank' href='" + jokeLink + "'>" + jokeText + "</a>"})
							}
							catch (error) {
								callback({message: "I don't know any jokes.", html: "unable to access jokes"})
							}
						})
				} catch (error) {}
			},
			"get a quote": function(remainder, callback) {
				try {
					// options
						var options = {
							url: "http://api.forismatic.com/api/1.0/?method=getQuote&format=json&lang=en"
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response link
									if (response.quoteText && response.quoteAuthor) {
										var quoteLink   = response.quoteLink
										var quoteText   = response.quoteText
										var quoteAuthor = response.quoteAuthor
										callback({message: quoteAuthor + " said... " + quoteText, html: "<a target='_blank' href='" + quoteLink + "'>\"" + quoteText + "\" - " + quoteAuthor + "</a>"})
									}
									else {
										callback({message: "A wise man once said: the API didn't return any results.", html: "unable to access quotes"})
									}
							}
							catch (error) {
								callback({message: "I don't know any quotes.", html: "unable to access quotes"})
							}
						})
				} catch (error) {}
			},
			"get the headlines": function(remainder, callback) {
				try {
					// initial callback
						callback({message: "Let me fetch the latest news.", html: "querying the New York Times..."})

					// options
						var options = {
							url: "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml"
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// construct response list
									var list = response.rss.channel.item
									var stories = []
									var storyItems = []
									for (var i = 0; i < list.length - 1; i++) {
										stories.push(list[i].title + " " + list[i].description)
										storyItems.push("<li><a target='_blank' href='" + list[i].link + "'><b>" + list[i].title + "</b></a><p>" + list[i].description + "</p></li>")
									}

								// message, link, list
									var message = "I found " + stories.length + " stor" + (list.length == 1 ? "y" : "ies") + "."
									callback({message: message + " " + stories.join("... "), html: message + "<ul>" + storyItems.join("") + "</ul>"})
							}
							catch (error) {
								callback({message: "I can't get the news.", html: "unable to access headlines"})
							}
						})
				} catch (error) {}
			},
			"get the weather": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["open weather api"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for open weather api.", html: "missing configuration: <b>open weather api</b>"})
							return
						}

					// locale
						if (remainder) {
							var locale = (" " + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"")).toLowerCase().replace(/ in | at | for | inside /gi,"").trim() || window.CONFIGURATION_LIBRARY["city"] || window.CONFIGURATION_LIBRARY["zip code"] || null
						}
						else {
							var locale = window.CONFIGURATION_LIBRARY["city"] || window.CONFIGURATION_LIBRARY["zip code"] || null
						}

					// no locale
						if (!locale) {
							window.CONTEXT_LIBRARY.flow = "get the weather"
							window.CONTEXT_LIBRARY["get the weather"] = {
								locale: null
							}

							callback({message: "What city should I get the weather for?", html: "What <b>city</b> should I get the weather for?"})
						}

					// yes locale
						else {
							// options
								var options = {
									url: "https://api.openweathermap.org/data/2.5/forecast?appid=" + CONFIGURATION_LIBRARY["open weather api"] + (isNaN(locale) ? ("&q=" + locale) : "&zip=" + locale) + ",us&mode=json&units=imperial"
								}

							// proxy to server
								window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
									try {
										// invalid response
											if (!response || !response.city || !response.list) {
												callback({message: "I was unable to get the weather.", html: "I was unable to get the weather."})
											}

										// valid response
											else {
												// days of the week
													var allDays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]

												// axes
													var dayColumns = []
													var timeRows = []
													for (var l in response.list) {
														var segment = response.list[l]
														var date = new Date(response.list[l].dt_txt + " UTC")
														
														segment.day = allDays[new Date(date).getDay()]
														if (dayColumns[dayColumns.length - 1] !== segment.day) {
															dayColumns.push(segment.day)
														}
														
														segment.time = date.toLocaleTimeString()
														if (!timeRows.includes(segment.time)) {
															timeRows.push(segment.time)
														}

														segment.cell = "<td>" + segment.main.temp + "°F<br><br>" + (segment.weather ? segment.weather[0].description : "clear") + "</td>"
													}

												// sort times
													timeRows.sort(function(a,b) {
														a = a.replace(/\:/g,"")
														b = b.replace(/\:/g,"")
														if (a.toLowerCase().includes("pm")) { a = Number(a.replace(/pm/gi,"")) % 120000 + 120000 } else { a = Number(a.replace(/am/gi, "")) % 120000 }
														if (b.toLowerCase().includes("pm")) { b = Number(b.replace(/pm/gi,"")) % 120000 + 120000 } else { b = Number(b.replace(/am/gi,"")) % 120000 }
														return a - b
													})

												// grid
													var grid = {}
													for (var t in timeRows) {
														grid[timeRows[t]] = {}
														grid[timeRows[t]].time = "<td>" + timeRows[t] + "</td>"
														for (var d in dayColumns) {
															grid[timeRows[t]][dayColumns[d]] = "<td> - </td>"
														}
													}

													for (var l in response.list) {
														var data = response.list[l]
														grid[data.time][data.day] = data.cell
													}

												// draw table
													var heading = "<tr><th>&#128339;</th>"
													for (var d in dayColumns) {
														heading += ("<th>" + dayColumns[d] + "</th>")
													}
													heading += "</tr>"

													var table = "<table><tbody>" + heading
													for (var y in grid) {
														var row = "<tr>"
														for (var x in grid[y]) {
															row += grid[y][x]
														}
														row += "</tr>"
														table += row
													}
													table += "</tbody></table>"

												// current weather
													var currentTemperature = "unknown"
													var currentWeather = "unknown"

												// send response
													var locale = response.city.name + ", " + response.city.country
													var conditions = "Right now it's " + response.list[0].main.temp + " degrees and " + (response.list[0].weather ? response.list[0].weather[0].description : "clear")
													var message = "Here's the weather for " + locale + "."
													var link = "<b><a target='_blank' href='https://openweathermap.org/find?q=" + locale + "'>" + message + "</a></b>"
													callback({message: message + " ... " + conditions, html: link + "<br>" + table})
											}
									}
									catch (error) {
										callback({message: "I was unable to get the weather: " + remainder, html: "I was unable to get the weather: <b>" + remainder + "</b>."})
									}
								})
						}
				} catch (error) {}
			},

		// Google Apps Script
			"wish list": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google apps script"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google apps script.", html: "missing configuration: <b>google apps script</b>"})
							return
						}

					// split at keywords
						remainder = " " + remainder
						var cost = remainder.split(/ for | costing | that costs | which costs /gi)
							cost = (cost[1] || cost[0]).split(/ called | named | by the name | which is a | which is an | which is the /gi)[0].trim()

						var item = remainder.split(/ called | named | by the name /gi)
							item = (item[1] || item[0]).split(/ for | costing | that costs | which costs | which is a | which is an | which is the /gi)[0].trim()

						var type = remainder.split(/ which is a | which is an | which is the /gi)
							type = (type[1] || type[0]).split(/ for | costing | that costs | which costs | called | named | by the name /gi)[0].trim()

					// build options
						var options = {
							url: window.CONFIGURATION_LIBRARY["google apps script"] + "&action=listWish&item=" + item + "&cost=" + cost + "&type=" + type
						}
						
					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							var responseHTML = "<ul><li><b>item: </b>" + response.item + "</li><li><b>cost: </b>" + response.cost + "</li><li><b>type: </b>" + response.type + "</li></ul>" 
							callback({message: response.message, html: responseHTML})
						})
				} catch (error) {}
			},
			"get balance": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google apps script"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google apps script.", html: "missing configuration: <b>google apps script</b>"})
							return
						}

					// build options
						var options = {
							url: window.CONFIGURATION_LIBRARY["google apps script"] + "&action=getBalance&account=" + remainder.replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").toLowerCase().trim()
						}
						
					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							var responseHTML = "<ul><li><b>account: </b>" + response.account + "</li><li><b>amount: </b>" + response.amount + "</li></ul>" 
							callback({message: response.message, html: responseHTML})
						})
				} catch (error) {}
			},
			"log purchase": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google apps script"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google apps script.", html: "missing configuration: <b>google apps script</b>"})
							return
						}

					// split at keywords
						remainder = " " + remainder
						var amount = remainder.split(/ for | costing | that cost | that costs | which cost | which costs /gi)
							amount = (amount[1] || amount[0]).split(/ called | named | by the name | item | which is a | which is an | which is the | which is type | which is category | which is | type | category /gi)[0].trim()
							amount = amount.replace("$","")

						var description = remainder.split(/ called | named | by the name | item /gi)
							description = (description[1] || description[0]).split(/ for | costing | that cost | that costs | which cost | which costs | which is a | which is an | which is the | which is type | which is category | which is | type | category /gi)[0].trim()

						var category = remainder.split(/ which is a | which is an | which is the | which is type | which is category | which is | type | category /gi)
							category = (category[1] || category[0]).split(/ for | costing | that cost | that costs | which cost | which costs | called | named | by the name | item /gi)[0].trim()

					// build options
						var options = {
							url: window.CONFIGURATION_LIBRARY["google apps script"] + "&action=logPurchase&category=" + category + "&description=" + description + "&amount=" + amount
						}
						
					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							var responseHTML = "<ul><li><b>description: </b>" + response.description + "</li><li><b>amount: </b>" + response.amount + "</li><li><b>category: </b>" + response.category + "</li></ul>" 
							callback({message: response.message, html: responseHTML})
						})
				} catch (error) {}
			},
			"fetch events": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google apps script"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google apps script.", html: "missing configuration: <b>google apps script</b>"})
							return
						}

					// split at keywords
						remainder = " " + remainder
						var startDate = remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"").split(/ from | starting at | start date | start time | between | for /gi)
							startDate = (startDate[1] || startDate[0]).split(/ to | until | ending at | end date | end time | and | through /gi)[0].toLowerCase().trim()
							if (startDate == "today")     { startDate = new Date().toLocaleDateString() }
							if (startDate == "yesterday") { startDate = new Date(new Date().getTime() - (1000 * 60 * 60 * 24)).toLocaleDateString() }
							if (startDate == "tomorrow")  { startDate = new Date(new Date().getTime() + (1000 * 60 * 60 * 24)).toLocaleDateString() }

						var endDate = remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"").split(/ to | until | ending at | end date | end time | and | through /gi)
							endDate = (endDate[1] || endDate[0]).split(/ from | starting at | start date | start time | between | for /gi)[0].toLowerCase().trim()
							if (endDate == "today")     { endDate = new Date().toLocaleDateString() }
							if (endDate == "yesterday") { endDate = new Date(new Date().getTime() - (1000 * 60 * 60 * 24)).toLocaleDateString() }
							if (endDate == "tomorrow")  { endDate = new Date(new Date().getTime() + (1000 * 60 * 60 * 24)).toLocaleDateString() }

					// build options
						var options = {
							url: window.CONFIGURATION_LIBRARY["google apps script"] + "&action=fetchEvents" + (startDate ? "&startDate=" + startDate : "") + (endDate ? "&endDate=" + endDate : "")
						}
						
					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							// create list
								var eventList = []
								var eventItems = []
								if (response.events) {
									for (var i = 0; i < response.events.length; i++) {
										var event = response.events[i]
										var startTime = new Date(event.startTime).toLocaleString()
										var endTime = new Date(event.endTime).toLocaleString()

										eventList.push(event.title + " from " + startTime + " until " + endTime + " at " + (event.location || "unknown location"))
										eventItems.push("<li><b>" + event.title + "</b><p>" + startTime + " - " + endTime + "<br><a target='_blank' href='https://www.google.com/maps/?q=" + event.location + "'>" + event.location + "</a><br>" + event.description + "</p></li>")
									}
								}

							// send response
								var responseLink = "https://calendar.google.com"
								var responseText = response.message
								callback({message: response.message + " " + eventList.join("..."),html: "<a target='_blank' href='" + responseLink + "'>" + responseText + "</a><ul>" + eventItems.join("") + "</ul>"})
						})
				} catch (error) {}
			},

		// Google APIs
			"google search": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google custom search"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google custom search.", html: "missing configuration: <b>google custom search</b>"})
							return
						}
						else if (!window.CONFIGURATION_LIBRARY["google api key"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google api key.", html: "missing configuration: <b>google api key</b>"})
							return
						}

					// options
						var options = {
							url: window.CONFIGURATION_LIBRARY["google custom search"] + "&key=" + window.CONFIGURATION_LIBRARY["google api key"] + "&q=" + remainder
						}

					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							// no results?
								if (!response.items || !response.items.length) {
									var responseLink = "https://www.google.com?q=" + remainder
									var responseText = "No results found."
									var topResultText = ""
									var topResult = ""
								}

							// 1+ results
								else {
									var responseLink = "https://www.google.com?q=" + remainder
									var responseText = "Top result:"
									var topResultText = response.items[0].title + " " + response.items[0].snippet
									var topResult = "<p><a target='_blank' href='" + response.items[0].link + "'><b>" + response.items[0].title + "</b></a><br>" + response.items[0].snippet + "</p>"
								}

							// send response								
								callback({message: responseText + " " + topResultText, html: "<a target='_blank' href='" + responseLink + "'>" + responseText + "</a>" + topResult})
						})
				} catch (error) {}
			},
			"google directions": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google api key"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google api key.", html: "missing configuration: <b>google api key</b>"})
							return
						}

					// split at keywords
						remainder = " " + remainder
						var origin = remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"").split(/ leaving from | from | starting at | start at | etween | originating at | origin /gi)
							origin = (origin[1] || origin[0]).split(/ going to | go to | ending at | end at | to | and | arriving at | destination | for /gi)[0].toLowerCase().trim()

						var destination = remainder.replace(/[?!,;'"_\(\)\$\%]/gi,"").split(/ going to | go to | ending at | end at | to | and | arriving at | destination | for /gi)
							destination = (destination[1] || destination[0]).split(/ leaving from | from | starting at | start at | between | originating at | origin /gi)[0].toLowerCase().trim()

					// options
						var options = {
							url: "https://maps.googleapis.com/maps/api/directions/json?key=" + window.CONFIGURATION_LIBRARY["google api key"] + "&origin=" + origin + "&destination=" + destination
						}

					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							// no results?
								if (!response || !response.routes || !response.routes[0] || !response.routes[0].legs || !response.routes[0].legs[0]) {
									callback({message: "I couldn't find a route.", html: "unable to route from " + origin + " to " + destination})
								}

							// format response
								else {
									var distance = response.routes[0].legs[0].distance.text
									var duration = response.routes[0].legs[0].duration.text
									var steps = response.routes[0].legs[0].steps.map(function(step) {
										return "<li><b>" + step.distance.text + " (" + step.duration.text + ")" + "</b><br>" + step.html_instructions + "</li>"
									}) || []

									var message = origin + " to " + destination + " is " + distance + " for " + duration + "."
									var link = "<a target='_blank' href='https://www.google.com/maps/dir/" + origin + "/" + destination + "'>" + message + "</a>"
									callback({message: message, html: link + "<ol>" + steps.join("") + "</ol>"})
								}
						})
				} catch (error) {}
			},
			"google places": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google api key"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google api key.", html: "missing configuration: <b>google api key</b>"})
							return
						}

					// options
						var options = {
							url: "https://maps.googleapis.com/maps/api/place/findplacefromtext/json?key=" + window.CONFIGURATION_LIBRARY["google api key"] + "&inputtype=textquery&fields=place_id&input=" + remainder
						}

					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							// no results?
								if (!response || !response.candidates || !response.candidates[0] || !response.candidates[0].place_id) {
									callback({message: "I couldn't find that place.", html: "unable to find " + remainder})
								}

							// second trip, with place_id
								else {
									var place_id = response.candidates[0].place_id
									var options = {
										url: "https://maps.googleapis.com/maps/api/place/details/json?key=" + window.CONFIGURATION_LIBRARY["google api key"] + "&inputtype=textquery&fields=name,photo,url,website,formatted_phone_number,formatted_address,geometry,opening_hours&place_id=" + place_id
									}

									window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
										// no results?
											if (!response || !response.result) {
												callback({message: "I couldn't find that place.", html: "unable to find " + remainder})
											}

										// format response
											else {
												var place = response.result
												if (place.opening_hours) {
													var openNow = "It's currently " + (place.opening_hours.open_now ? " open." : "closed.")
													var openHours = "<br><ul><li>" + place.opening_hours.weekday_text.join("</li><li>") + "</li></ul>"
												}
												else {
													var openNow = ""
													var openHours = ""
												}

												var message = "I found " + place.name + " at " + (place.formatted_address || "an unknown address") + ". " + openNow
												var infoBlock = "<b>" + place.name + "</b><ul><li><a target='_blank' href='" + place.url + "'>" + (place.formatted_address || "<i>no address found</i>") + "</a></li><li>" + (place.formatted_phone_number || "<i>no phone number found</i>") + "</li><li>" + (place.website ? ("<a target='_blank' href='" + place.website + "'>" + place.website + "</a>") : "<i>no website found</i>") + "<li>hours: " + (openHours || "<i>no hours found</i>") + "</li>" + "</ul>"
												callback({message: message, html: infoBlock})
											}
									})
								}
						})
				} catch (error) {}
			},
			"youtube": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["google api key"]) {
							callback({message: "I'm not authorized to do that yet. Set a configuration for google api key.", html: "missing configuration: <b>google api key</b>"})
							return
						}

					// options
						var options = {
							url: "https://www.googleapis.com/youtube/v3/search?key=" + window.CONFIGURATION_LIBRARY["google api key"] + "&part=snippet&type=video&videoEmbeddable=true&maxResults=5&order=viewCount&q=" + remainder
						}

					// proxy request
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							if (!response || !response.items || !response.items.length || !response.items[0].id || !response.items[0].id.videoId) {
								callback({message: "I couldn't find " + remainder + " on Youtube.", html: "unable to find <b>" + remainder + "</b> on Youtube."})
							}
							else {
								// turn off whistle-on
									CONFIGURATION_LIBRARY.settings["whistle-on"] = ELEMENT_LIBRARY["inputs-whistle-on"].checked = false
									window.localStorage.setItem("CONFIGURATION_LIBRARY", JSON.stringify(CONFIGURATION_LIBRARY))
									FUNCTION_LIBRARY.stopRecognizing(false)

								// response
									var responseHTML = '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + response.items[0].id.videoId + '?autoplay=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>'
									callback({message: "Now playing " + remainder, html: responseHTML, followup: false})
							}
						})
				}
				catch (error) {}
			},

		// games
			"more or less": function(remainder, callback) {
				try {					
					// pick a number
						if (window.CONTEXT_LIBRARY.flow !== "more or less") {
							window.CONTEXT_LIBRARY.flow = "more or less"
							window.CONTEXT_LIBRARY["more or less"] = {
								number: Math.floor(Math.random() * 100) + 1,
								guesses: 0
							}

							callback({message: "Okay, I'm thinking of a number between 1 and 100.", html: "<b>I'm thinking of a number between 1 and 100.</b><br>Make a guess. I'll tell you if my number is more or less."})
						}

					// interpret guess
						else {
							var guess = Number(window.FUNCTION_LIBRARY.getDigits(remainder))
							if (isNaN(guess)) {
								callback({message: "I don't know that number.", html: "not a number: " + remainder})
							}
							else {
								// increase guess count
									window.CONTEXT_LIBRARY["more or less"].guesses++

								// correct
									if (guess == window.CONTEXT_LIBRARY["more or less"].number) {
										var message = "You took " + window.CONTEXT_LIBRARY["more or less"].guesses + " guess" + (window.CONTEXT_LIBRARY["more or less"].guesses == 1 ? "" : "es") + " to find my number: " + window.CONTEXT_LIBRARY["more or less"].number + "."
										var messageBlock = "You took <b>" + window.CONTEXT_LIBRARY["more or less"].guesses + "</b> guess" + (window.CONTEXT_LIBRARY["more or less"].guesses == 1 ? "" : "es") + " to find my number: <b>" + window.CONTEXT_LIBRARY["more or less"].number + "</b>."
										callback({message: message, html: messageBlock})

										window.CONTEXT_LIBRARY.flow = null
										delete window.CONTEXT_LIBRARY["more or less"]
									}

								// more
									else if (window.CONTEXT_LIBRARY["more or less"].number > guess) {
										var message = "More than " + guess + "."
										callback({message: message, html: "&uarr; " + message + " &uarr;"})
									}

								// less
									else if (window.CONTEXT_LIBRARY["more or less"].number < guess) {
										var message = "Less than " + guess + "."
										callback({message: message, html: "&darr; " + message + " &darr;"})
									}
							}
						}
				}
				catch (error) {}
			},
			"true or false": function(remainder, callback) {
				try {					
					// pick a number
						if (window.CONTEXT_LIBRARY.flow !== "true or false") {
							// options
								var options = {
									url: "https://opentdb.com/api.php?amount=10&type=boolean"
								}

							// proxy to server
								window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
									try {
										// enter flow
											window.CONTEXT_LIBRARY.flow = "true or false"
											window.CONTEXT_LIBRARY["true or false"] = {
												score: 0,
												index: 0,
												questions: response.results
											}

										// first question
											var question = window.CONTEXT_LIBRARY["true or false"].questions[window.CONTEXT_LIBRARY["true or false"].index].question
												question = question.replace(/(&#039;)/gi,"\'")
											var questionNumber = window.CONTEXT_LIBRARY["true or false"].index + 1
											callback({message: "True or False: " + question, html: "<b>True or False #" + questionNumber + "</b><br>" + question})
									}
									catch (error) {
										window.CONTEXT_LIBRARY.flow = null
										callback({message: "I don't know any fun facts.", html: "unable to access trivia"})
									}
								})
						}

					// interpret guess
						else {
							// validate
								var guess = remainder.toLowerCase().replace(/[?!.,:;'"_\/\(\)\$\%]/gi,"").trim()
								if (guess.includes("true")) {
									guess = "True"
								}
								else if (guess.includes("false")) {
									guess = "False"
								}
								else {
									callback({message: "I only understand True and False.", html: "invalid guess: " + remainder})
									return
								}

							// correct
								var correctAnswer = window.CONTEXT_LIBRARY["true or false"].questions[window.CONTEXT_LIBRARY["true or false"].index].correct_answer
								if (guess == correctAnswer) {
									window.CONTEXT_LIBRARY["true or false"].score++
									var message = guess.toUpperCase() + " is correct!"
								}

							// incorrect
								else {
									var message = "Sorry, this is actually " + correctAnswer.toUpperCase() + "."
								}

							// advance
								if (window.CONTEXT_LIBRARY["true or false"].index + 1 < window.CONTEXT_LIBRARY["true or false"].questions.length) {
									window.CONTEXT_LIBRARY["true or false"].index++

									var nextQuestion = window.CONTEXT_LIBRARY["true or false"].questions[window.CONTEXT_LIBRARY["true or false"].index].question
									var nextQuestionNumber = window.CONTEXT_LIBRARY["true or false"].index + 1

									callback({message: message + " ... " + "Question " + nextQuestionNumber + ": True or False: " + nextQuestion, html: message + "<br><br><b>True or False #" + nextQuestionNumber + "</b><br>" + nextQuestion})
								}

							// done
								else {
									var finalScore = window.CONTEXT_LIBRARY["true or false"].score || 0

									window.CONTEXT_LIBRARY.flow = null
									delete window.CONTEXT_LIBRARY["true or false"]

									callback({message: message + " ... " + "You got " + finalScore + " questions correct.", html: message + "<br><br><b>Final score: " + finalScore + "</b>"})
								}
						}
				}
				catch (error) {}
			},
	
		// SONOS

		// Wink
			"get wink devices": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["api.wink.com"] || !window.CONFIGURATION_LIBRARY["api.wink.com"].access_token || !window.CONFIGURATION_LIBRARY["api.wink.com"].expiration || window.CONFIGURATION_LIBRARY["api.wink.com"].expiration < new Date().getTime()) {
							callback({message: "I'm not authorized to do that yet. Authorize Wink first.", html: "missing authorization: <b>api.wink.com</b>"})
							return
						}

					// build options
						var options = {
							url: "https://api.wink.com/users/me/wink_devices?client_id=" + window.CONFIGURATION_LIBRARY["wink key"] + "&client_secret=" + window.CONFIGURATION_LIBRARY["wink secret"],
							Authorization: "Bearer " + window.CONFIGURATION_LIBRARY["api.wink.com"].access_token
						}
						
					// proxy
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							// devices
								var devices = {}
								for (var i in response.data) {
									var device = {
										uuid: response.data[i].uuid,
										name: response.data[i].name,
										model_name: response.data[i].model_name,
										type: null
									}
									devices[device.uuid] = device

									if (response.data[i].light_bulb_id) {
										device.type = "light_bulb"
									}
									else if (response.data[i].smoke_detector_id) {
										device.type = "smoke_detector"
									}
									else if (response.data[i].air_conditioner_id) {
										device.type = "air_conditioner"
									}
									else if (response.data[i].thermostat_id) {
										device.type = "thermostat"
									}
									else if (response.data[i].outlets) {
										device.type = "power_strip"

										for (var j in response.data[i].outlets) {
											var subdevice = {
												uuid: response.data[i].outlets[j].uuid,
												name: response.data[i].outlets[j].name,
												model_name: device.model_name + " (outlet)",
												type: "power_strip"
											}
											devices[subdevice.uuid] = subdevice
										}
									}
								}
								
								var value = window.CONFIGURATION_LIBRARY["api.wink.com"]
									value.devices = devices
								window.FUNCTION_LIBRARY.changeConfiguration({key: "api.wink.com", value: value})

							// response
								var responseHTML = "Here are your Wink devices: <ul>"
								for (var i in devices) {
									responseHTML += "<li><b>" + devices[i].name + "</b><br>" + devices[i].model_name + "</li>"
								}
								responseHTML += "</ul>"
								callback({message: "I detected " + Object.keys(devices).length + " devices on Wink.", html: responseHTML})
						})
				} catch (error) {}
			},
			"set wink devices": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["api.wink.com"] || !window.CONFIGURATION_LIBRARY["api.wink.com"].access_token || !window.CONFIGURATION_LIBRARY["api.wink.com"].expiration || window.CONFIGURATION_LIBRARY["api.wink.com"].expiration < new Date().getTime()) {
							callback({message: "I'm not authorized to do that yet. Authorize Wink first.", html: "missing authorization: <b>api.wink.com</b>"})
							return
						}
						else if (!window.CONFIGURATION_LIBRARY["api.wink.com"].devices || !Object.keys(window.CONFIGURATION_LIBRARY["api.wink.com"].devices).length) {
							callback({message: "I don't have any saved devices. Get devices first.", html: "missing devices: <b>api.wink.com</b>"})
							return
						}

					// split remainder
						var components = remainder.split(/\sto\s|\sbecome\s|\sinto\s|\sat\s/gi)
						var deviceName = components[0].toLowerCase().trim()
						var desiredState = components[1].toLowerCase().trim()

					// replace number words with numbers
						deviceName = deviceName.split(/\s/gi)
						for (var word in deviceName) {
							deviceName[word] = window.FUNCTION_LIBRARY.getDigits(deviceName[word])
						}
						deviceName = deviceName.join(" ")

					// identify devices
						var deviceIds = []
						if (deviceName == "all lights" || deviceName == "all the lights") {
							deviceIds = Object.keys(window.CONFIGURATION_LIBRARY["api.wink.com"].devices).filter(function(d) {
								return window.CONFIGURATION_LIBRARY["api.wink.com"].devices[d].type == "light_bulb"
							}) || []
						}
						else {
							deviceNames = deviceName.split(" and ")
							for (var i in deviceNames) {
								var deviceId = Object.keys(window.CONFIGURATION_LIBRARY["api.wink.com"].devices).find(function(d) {
									return window.CONFIGURATION_LIBRARY["api.wink.com"].devices[d].name.toLowerCase() == deviceNames[i]
								}) || null
								if (deviceId) {
									deviceIds.push(deviceId)
								}
							}
						}

						if (!deviceIds.length) {
							callback({message: "I couldn't identify that device.", html: "unable to find device: " + deviceName})
							return
						}

					// identify state
						if (desiredState == "on" || desiredState == "active" || desiredState == "powered") {
							desiredState = {powered: true}
						}
						else if (desiredState == "off" || desiredState == "inactive" || desiredState == "unpowered") {
							desiredState = {powered: false}
						}
						else {
							callback({message: "I couldn't understand that desired state.", html: "unable to set state: " + desiredState})
							return
						}

					// output response
						var responseHTML = "Wink devices updated: <ul>"
						for (var i in deviceIds) {
							responseHTML += "<li>" + window.CONFIGURATION_LIBRARY["api.wink.com"].devices[deviceIds[i]].name + ": " + JSON.stringify(desiredState) + "</li>"
						}
						responseHTML += "</ul>"
						callback({message: "Okay, I set " + deviceName + " to " + (desiredState.powered ? "on" : "off"), html: responseHTML})

					// loop through ids
						for (var i in deviceIds) {
							// build options
								var options = {
									method: "put",
									url: "https://api.wink.com/" + window.CONFIGURATION_LIBRARY["api.wink.com"].devices[deviceIds[i]].type + "s/" + deviceIds[i] + "/desired_state?client_id=" + window.CONFIGURATION_LIBRARY["wink key"] + "&client_secret=" + window.CONFIGURATION_LIBRARY["wink secret"],
									Authorization: "Bearer " + window.CONFIGURATION_LIBRARY["api.wink.com"].access_token,
									body: {
										"desired_state": desiredState
									}
								}

							// proxy
								window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
									console.log(response)
								})
						}
				} catch (error) { callback({message: "I couldn't identify that device.", html: "unable to find device: " + remainder}) }
			},
			"turn off wink device": function(remainder, callback) {
				try {
					window.ACTION_LIBRARY["set wink devices"](remainder + " to off", callback)
				}
				catch (error) {}
			},
			"turn on wink device": function(remainder, callback) {
				try {
					window.ACTION_LIBRARY["set wink devices"](remainder + " to on", callback)
				}
				catch (error) {}
			},

		// Reddit
			"ask reddit": function(remainder, callback) {
				try {
					// missing config?
						if (!window.CONFIGURATION_LIBRARY["www.reddit.com"] || !window.CONFIGURATION_LIBRARY["www.reddit.com"].access_token || !window.CONFIGURATION_LIBRARY["www.reddit.com"].expiration || window.CONFIGURATION_LIBRARY["www.reddit.com"].expiration < new Date().getTime()) {
							callback({message: "I'm not authorized to do that yet. Authorize Wink first.", html: "missing authorization: <b>www.reddit.com</b>"})
							return
						}

					// options
						var options = {
							"User-Agent": "web:bluejay:v1 (by /u/quargy)",
							Authorization: "Bearer " + window.CONFIGURATION_LIBRARY["www.reddit.com"].access_token,
							url: "https://oauth.reddit.com/r/askreddit/"
						}

					// proxy to server
						window.FUNCTION_LIBRARY.proxyRequest(options, function(response) {
							try {
								// select random question
									var question = response.data.children[Math.floor(Math.random() * response.data.children.length)]

								// construct response link
									var redditLink = question.data.url
									var redditText = question.data.title
									callback({message: redditText, html: "<a target='_blank' href='" + redditLink + "'>" + redditText + "</a>"})
							}
							catch (error) {
								callback({message: "I don't have any questions.", html: "unable to ask reddit"})
							}
						})
				}
				catch (error) {}
			},
	}
